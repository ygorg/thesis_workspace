import util
import json
from collections import Counter, defaultdict
import spacy
from tqdm import tqdm

def preproc_spacy(kws, lang):
    nlp = spacy.load(lang)

    sp_out = list(tqdm(nlp.pipe(kws, as_tuples=True, n_threads=5, disable=['ner', 'parser'])))
    preproc = [(tuple(t.pos_ for t in r[0]), r[0].text, r[1]) for r in sp_out]
    return preproc

def preproc_corenlp(kws, lang):
    res = []
    with CoreNLPClient(properties=lang, be_quiet=True, annotators=['tokenize', 'ssplit', 'pos']) as nlp:
        for k, c in tqdm(kws):
            tmp = [(t.word, t.pos) for s in nlp.annotate(k).sentence for t in s.token]
            tmp = (tuple(e[1] for e in tmp), ' '.join(e[0] for e in tmp), c)
            if lang == 'en':
                # Map penntreebank ppostag to UD
                pp, t, c = tmp
                tmp = (tuple(nlp.map_tag('en-ptb', 'universal', e) for e in pp), t, c, pp)
            res.append(tmp)
    return res


with open(util.get_ref('TermITH-Eval')) as f:
    ref = json.load(f)
    kws = Counter(v for d in ref.values() for k in d for v in k)
    kws = [(k, v) for k, v in kws.items() if k]

preproc = preproc_spacy(kws, 'fr')

pattern = defaultdict(list)
for p in preproc:
    pattern[p[0]].append(p)

pattern_count = sorted((sum(p[2] for p in v), k) for k, v in pattern.items())

nb_top_5 = sum(o[0] for o in pattern_count[-5:])
nb_total = sum(o[0] for o in pattern_count)
print(nb_top_5, nb_total, round(nb_top_5/nb_total*100, 2))

print([(round(n/nb_total*100,2), list(p)) for n, p in pattern_count[-5:][::-1]])


""" KP20k (en) corenlp 4.1
77946 105560 73.84

[(27.46, ['NOUN']),
 (21.36, ['NOUN', 'NOUN']),
 (16.91, ['ADJ', 'NOUN']),
 (4.92, ['ADJ', 'NOUN', 'NOUN']),
 (3.2, ['NOUN', 'NOUN', 'NOUN'])]
"""

""" KP20k (en) spacy
(82912, 107446)

[(25532, 23.76, ('NOM',)),
 (21143, 19.68, ('NOM', 'NOM')),
 (16976, 15.8, ('ADJ', 'NOM')),
 (5184, 4.82, ('ADJ', 'NOM', 'NOM')),
 (3280, 3.05, ('VERB',)),
 (3115, 2.9, ('VERB', 'NOM')),
 (3108, 2.89, ('NOM', 'NOM', 'NOM')),
 (1717, 1.6, ('ADJ',)),
 (1704, 1.59, ('ADJ', 'ADJ', 'NOM')),
 (1153, 1.07, ('NOM', 'VERB'))]
"""

""" TermITH-Eval (fr) spacy
3995 4713

[(1721, 36.52, ('NOM',)),
 (888, 18.84, ('NOM', 'ADJ')),
 (483, 10.25, ('ADJ',)),
 (256, 5.43, ('NOM', 'NOM')),
 (194, 4.12, ('VERB',)),
 (132, 2.8, ('ADJ', 'ADJ')),
 (107, 2.27, ('NOM', 'ADP', 'NOM')),
 (85, 1.8, ('NOM', 'DET', 'NOM')),
 (68, 1.44, ('ADJ', 'NOM')),
 (61, 1.29, ('VERB', 'ADJ'))]
"""



length = Counter(len(p[0]) for p in preproc)
# {"3": 12196, "2": 25913, "1": 8499, "4": 6154, "5": 2234, "7": 581, "8": 275, "6": 1260, "13": 20, "14": 5, "15": 12, "9": 131, "12": 23, "16": 5, "10": 64, "27": 1, "78": 1, "19": 2, "23": 1, "11": 43, "17": 2, "18": 4, "30": 2, "22": 3, "20": 1, "21": 1}
length = sorted(map(tuple, length.items()), key=lambda x: x[0])
sns.plot(length)


def dist_kp_per_doc(ref):
    return Counter(len(v) for v in ref.items())

dist_datasets = {}
for d in util.reference:
    ref_path = util.get_ref(d)
    if ref_path is None:
        ref_path = util.get_ref(d + '.stem')
    if not ref_path:
        continue
    with open(ref_path) as f:
        ref = json.load(f)
    dist_datasets[d] = dist_kp_per_doc(ref)


"""
{"CSTR": {"3": 69, "4": 99, "6": 64, "8": 35, "5": 132, "7": 47, "9": 15, "10": 11, "2": 11, "19": 1, "11": 5, "22": 1, "16": 2, "1": 4, "18": 1, "12": 3}, "NUS": {"27": 4, "29": 3, "24": 3, "7": 12, "2": 7, "9": 18, "5": 13, "10": 17, "12": 16, "15": 8, "14": 20, "18": 4, "8": 7, "13": 14, "16": 7, "6": 4, "11": 9, "3": 15, "4": 17, "19": 5, "17": 3, "34": 2, "28": 1, "41": 2}, "PubMed": {"4": 272, "5": 456, "7": 91, "6": 214, "3": 128, "13": 8, "10": 20, "9": 33, "2": 13, "8": 59, "1": 2, "12": 8, "34": 1, "21": 1, "11": 5, "14": 3, "18": 1, "20": 1, "15": 2, "17": 1, "19": 1}, "ACM": {"6": 293, "2": 93, "4": 551, "3": 376, "5": 540, "8": 96, "7": 147, "10": 32, "14": 9, "11": 23, "18": 5, "9": 57, "13": 21, "12": 17, "17": 9, "15": 7, "19": 7, "1": 2, "22": 1, "21": 1, "20": 5, "16": 10, "24": 2}, "ACM-abstract": {"6": 293, "2": 93, "4": 551, "3": 376, "5": 540, "8": 96, "7": 147, "10": 32, "14": 9, "11": 23, "18": 5, "9": 57, "13": 21, "12": 17, "17": 9, "15": 7, "19": 7, "1": 2, "22": 1, "21": 1, "20": 5, "16": 10, "24": 2}, "Citeulike-180": {"3": 19, "7": 15, "5": 46, "6": 26, "4": 40, "1": 3, "27": 1, "8": 11, "9": 1, "2": 10, "11": 3, "12": 1, "14": 2, "10": 2, "16": 1, "13": 1}, "SemEval-2010": {"19": 5, "13": 17, "15": 15, "14": 19, "16": 5, "10": 4, "12": 13, "20": 3, "11": 4, "21": 1, "17": 7, "18": 3, "25": 1, "24": 1, "8": 1, "28": 1}, "SemEval-2010-abstract": {"19": 5, "13": 17, "15": 15, "14": 19, "16": 5, "10": 4, "12": 13, "20": 3, "11": 4, "21": 1, "17": 7, "18": 3, "25": 1, "24": 1, "8": 1, "28": 1}, "Inspec": {"6": 48, "8": 45, "5": 44, "7": 52, "3": 11, "18": 11, "10": 41, "16": 16, "15": 19, "31": 1, "9": 32, "12": 23, "11": 33, "13": 17, "14": 23, "23": 4, "22": 4, "4": 32, "2": 10, "24": 1, "20": 3, "19": 7, "21": 8, "17": 12, "27": 1, "26": 1, "28": 1}, "KDD": {"6": 93, "2": 66, "5": 110, "4": 213, "3": 169, "1": 47, "8": 16, "7": 31, "10": 5, "12": 1, "9": 3, "13": 1}, "WWW": {"2": 73, "4": 331, "5": 278, "6": 184, "9": 27, "7": 85, "8": 51, "3": 235, "11": 9, "1": 27, "13": 2, "12": 5, "10": 14, "16": 1, "15": 3, "14": 4, "21": 1}, "TermITH-Eval": {}, "KP20k": {"3": 3452, "5": 5204, "4": 5341, "6": 2679, "2": 573, "8": 504, "7": 1002, "14": 44, "55": 1, "13": 43, "10": 155, "9": 260, "38": 3, "28": 25, "40": 5, "19": 38, "11": 87, "34": 11, "16": 41, "12": 69, "31": 17, "29": 17, "26": 23, "39": 2, "25": 18, "18": 33, "30": 20, "23": 33, "17": 38, "21": 46, "24": 25, "32": 15, "65": 1, "20": 39, "15": 37, "42": 4, "27": 17, "46": 1, "22": 24, "43": 2, "45": 1, "35": 11, "33": 11, "60": 1, "100": 1, "47": 3, "36": 9, "41": 1, "52": 1, "37": 2, "77": 1, "51": 1, "44": 2, "68": 2, "97": 1, "54": 1, "59": 1, "57": 1}, "DUC-2001": {"8": 63, "6": 47, "5": 9, "12": 6, "9": 45, "11": 28, "10": 29, "7": 71, "3": 1, "4": 4, "13": 4, "14": 1}, "110-PT-BN-KP": {"37": 1, "33": 1, "23": 2, "35": 1, "26": 1, "39": 1, "20": 1, "30": 1, "10": 1}, "500N-KPCrowd": {"13": 1, "45": 2, "34": 2, "23": 1, "40": 3, "47": 1, "60": 2, "73": 1, "44": 2, "55": 1, "54": 1, "52": 1, "76": 1, "103": 1, "80": 1, "68": 2, "37": 1, "75": 1, "25": 2, "41": 2, "39": 3, "32": 3, "14": 1, "27": 1, "26": 1, "21": 1, "31": 1, "35": 1, "50": 1, "82": 1, "11": 1, "64": 2, "18": 1, "62": 1, "48": 1, "102": 1}, "WikinewsKeyphrase": {"9": 22, "8": 18, "11": 14, "4": 1, "10": 8, "7": 7, "13": 6, "5": 3, "12": 7, "14": 7, "15": 1, "6": 5, "17": 1}, "KPTimes": {"3": 3215, "4": 4598, "5": 3853, "2": 1173, "7": 2045, "6": 2828, "8": 1210, "9": 693, "10": 385}, "NYTime": {"3": 3215, "4": 4598, "5": 3853, "2": 1173, "7": 2045, "6": 2828, "8": 1210, "9": 693, "10": 385}, "NTCIR1+2": {"6": 79778, "4": 69968, "2": 9550, "3": 52553, "5": 75893, "1": 1224, "7": 9554, "8": 17791, "11": 77, "10": 214, "9": 901, "13": 19, "12": 40, "18": 2, "15": 4, "14": 10, "22": 1, "16": 4, "21": 1, "17": 1}, "RefSeerX": {"13": 877, "18": 344, "11": 1329, "15": 618, "20": 304, "1": 340, "16": 486, "14": 732, "10": 541, "9": 301, "17": 432, "7": 344, "5": 330, "6": 333, "12": 1108, "3": 320, "8": 283, "19": 296, "2": 360, "4": 322}}
"""
